<!doctype html>
<title>{% block title %}{% endblock %} - Flaskr</title>
<link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Kanit&family=Montserrat&family=Open+Sans:wght@500&display=swap"
    rel="stylesheet">

<body>
    <div class="full-body-container">
        <div class="top-text">
            <div class="google-colors">
                <h1 id="google-4">B</h1>
                <h1 id="google-3">O</h1>
                <h1 id="google-0-1">O</h1>
                <h1 id="google-0-2">K</h1>
                <h1 id="google-4">H</h1>
                <h1 id="google-3">U</h1>
                <h1 id="google-0-1">B</h1>

            </div>
            <div class="input-box" onclick="sendFocus()">
                <img src="{{ url_for('static', filename='images/mag.png') }}" />
                <input placeholder="Search for a book" id="filter-text-val" onkeyup="fetchSuggestionsFromDatabase()">
            </div>
        </div>
        <div id="answer-box">

        </div>
        <div id="suggestions"></div>
    </div>

    <script>
        const searchInput = document.getElementById('filter-text-val');
        const suggestionsDiv = document.getElementById('suggestions');
        searchInput.addEventListener('input', async (event) => {
            const suggestions = await fetchSuggestionsFromDatabase(event);
            updateSuggestions(suggestions);
        });
    
        async function fetchSuggestionsFromDatabase(event) {
            const query = event.target.value;
            if (query.length>5){
                try {
                const response = await fetch(`/suggest?query=${query}`);
                
                if (!response.ok) {
                    throw new Error('Failed to fetch suggestions from the server');
                }

                const suggestions = await response.json();

                return suggestions;
                } catch (error) {
                    console.error('Error fetching suggestions:', error);
                    return []; 
                }
            }
            if (event.keyCode === 13){
                filterText();
            }
        }
    
        function updateSuggestions(suggestions) {
            suggestionsDiv.innerHTML = '';
            suggestions.forEach(book => {
                let bookElement = document.createElement('div');
                bookElement.innerHTML = answerBoxTemplate(row.Title, row.descript, row.review_score);
                document.getElementById("answer-box").appendChild(bookElement);
            });
        }
    </script>
    <script>

        function answerBoxTemplate(title, description, score) {
            return `
            <div class='recommendation-container'>
                <h3 class='book-title'>${title}</h3>
                <p class='book-description'>${description}</p>
                <p class='book-review-score'>Review Score: ${score}</p>
            </div>`;
        }

        function sendFocus() {
            document.getElementById('filter-text-val').focus()
        }

        function filterText(event) {
            if (event.keyCode === 13) { // Check if the key pressed is 'Enter'
                let searchText = document.getElementById("filter-text-val").value.trim();
                if (searchText !== "") {
                    fetch("/books?" + new URLSearchParams({ title: searchText }).toString())
                        .then((response) => response.json())
                        .then((data) => {
                            document.getElementById("answer-box").innerHTML = "";
                            data.slice(0, 5).forEach(row => {
                                let tempDiv = document.createElement("div");
                                tempDiv.innerHTML = answerBoxTemplate(row.Title, row.descript, row.review_score);
                                document.getElementById("answer-box").appendChild(tempDiv);
                            });
                        });
                }
            }
        }
    </script>
</body>