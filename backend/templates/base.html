<!DOCTYPE html>
<html>

<head>
    <title> - Book Hub</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit&family=Montserrat&family=Open+Sans:wght@500&display=swap"
        rel="stylesheet">

    <style>
        html,
        body,
        html {
            height: 100%;
            margin: 0;
            padding: 0;
            background-image: url("/static/images/left_shelf.jpg"), url("/static/images/right_shelf.jpg");
            background-position: left center, right center;
            background-repeat: no-repeat;
            background-size: auto 100vh;
            background-attachment: fixed;
            overflow-x: hidden;
        }

        body {
            background-image: url("/static/images/left_shelf.jpg"), url("/static/images/right_shelf.jpg");
            background-repeat: no-repeat, no-repeat;
            background-attachment: fixed;
            background-position: left top, right top; 
            background-size: 50% 100%, 50% 100%; 
            overflow-x: hidden;
        }

        .introduction-page {
            height: 100vh;
            width: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            background: url("/static/images/bookshop.png") no-repeat center center fixed;
            background-size: cover;
        }

        .introduction-text {
            width: 600px;
            padding: 20px;
            background-color: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            text-align: center;
            transform: translateX(+45%);
            color: white;
            box-shadow: 0 18px 30px 40px rgba(0, 0, 0, 0.3);
            font-weight: bold;
            font-size: 28px;
            text-shadow:
                -1.5px -1.5px 2px #000,
                1.5px -1.5px 2px #000,
                -1.5px 1.5px 2px #000,
                1.5px 1.5px 2px #000;
            gap: 10px;
        }

        .introduction-text p {
            margin-top: 10px;
            margin-bottom: 10px;
        }

        .button-group {
            margin-top: 5px;
            margin-bottom: 5px;
        }

        .full-body-container,
        .full-body-container-2,
        p,
        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
            text-align: center;

        }

        .recommendation-container {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            gap: 20px;
            margin: 20px 0;
            width: 100%;
            border: 3px solid black;
            transition: border-color 0.3s, box-shadow 0.3s;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .recommendation-container:hover {
            border-color: orange;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4);  
        }

        .book-image {
            width: 150px;
            height: auto;
            margin-left: 30px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        #answer-box {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%
        }
        .autocom-box ul {
            background-color: #F4ECD7;
            padding: 0; 
            list-style-type: none;
            margin: 0; 
        }

        .autocom-box ul li {
            background-color: #F4ECD7; 
            padding: 10px; 
            margin-bottom: 5px; 
            border-bottom: 1px solid #ddd;

        }
        .autocom-box-2{
            background-color: #F4ECD7;
            position: relative;
        }
        .input-box {
            border-radius: 50px;
            border: 1px solid black;
            display: flex;
            align-items: center;
            margin: 10px auto;
            padding: 10px;
            position: relative;
            width: 600px;
            background-color: transparent;
            
        }
        .input-box input {
            background-color: transparent; 
        }

        .input-box img {
            position: absolute;
            left: 3px;
            top: 50%;
            transform: translateY(-50%);
            z-index: 10;
        }
        .input-box input[type="text"] {
            width: 100%; 
            padding: 10px; 
            margin-left: 30px;
            border: none; 
            outline: none; 
        }
        .book-title {
            color: #8A6E43;
            font-weight: bold;
        }

        .book-description {
            color: #091241;
            line-height: 1.5;
        }

        .book-review-score {
            font-weight: bold;
            margin-top: 15px;
        }

        .book-version-title {
            color: #8A6E43;
            font-family: 'Kanit', sans-serif;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .book-version-descript {
            color: #515151;
            line-height: 1.5;
            margin-top: 0;
        }

        .book-image {
            width: auto;
            height: 200px;
            margin-left: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            object-fit: cover;
            border-radius: 5px;
        }
    </style>
</head>

<body>
    <div class="introduction-page" style="display: block;">
        <div class="introduction-page" style="display: block; padding-bottom: 20px;">
            <div class="introduction-text">
                <p>Welcome to our Book Hub! <br>Here you can get a personalized list of book recommendations from this
                    virtual bookstore to build your own personal library. Hope you enjoy!</p>
                <div class="button-group">
                    <p>To search books based on your favorite book, click below:</p>
                    <button onclick="showSearch('full-body-container')">Click to Continue</button>
                </div>
                <div class="button-group">
                    <p>To search books by mood/interest, click below:</p>
                    <button onclick="showSearch('full-body-container-2')">Click to Continue</button><br><br><br>
                </div>
            </div>
        </div>

        <div class="introduction-page" style="display: block; padding-bottom: 20px;">
            <div class="introduction-text">
                <p>Our Database</p>
                <p style="font-size: 0.8em;">Our data is based off of books sold on Amazon. The data includes the book
                    titles, descriptions, authors, publishers, categories, review scores, and review counts.</p>
                <p>Ranking Process</p>
                <p style="font-size: 0.8em;">The authors and categories of the books are matched with the selected book
                    by Jaccard Similarity, while the descriptions are matched by Cosine Similarity. <br>The review
                    scores and review counts are
                    used to further fine-tune our rankings, with the differences in review counts becoming less
                    important as the
                    count increases (i.e., 5 vs 50 reviews is a more important difference than 1000 vs 1100 reviews).
                </p>
                <p>When Inputting a Theme:</p>
                <p style="font-size: 0.8em;">The word you input is matched against the descriptions of the books in the database by an SVD computation. 
                    <br>This search emphasizes the words in the description of the book to determine the book that would fit the free form input word a user gives it.<br>
                    <br><br>
                </p>
            </div>
        </div>

        <div class="introduction-page" style="display: block;">
            <div class="introduction-text">
                <p>Thank you for visiting our Book Hub. We hope you find something great to read!</p>
            </div>
        </div>

    </div>
    <!-- This is for the search page based on favorite book -->
    <div class="full-body-container" style="display: none;">
        <button onclick="showIntroduction()">Go back to main page</button>
        <div class="top-text">
            <div class="google-colors">
                <h1 id="google-1">B</h1>
                <h1 id="google-2">O</h1>
                <h1 id="google-3">O</h1>
                <h1 id="google-4">K</h1>
                <h1 id="google-5">H</h1>
                <h1 id="google-2">U</h1>
                <h1 id="google-3">B</h1>
            </div>
            <h3 class='book-version-title'>Version: Book Title Input</h3>
            <p class='book-description'>Start typing in the title of a book you've already read and press "Enter"--we'll
                recommend
                books
                similar to it!</p>
            <div class="input-box">
                <img src="/static/images/mag.png" />
                <i class="fas fa-search"></i>
                <!-- adapted from https://dev.to/codingnepal/search-bar-with-autocomplete-search-suggestions-in-javascript-32dn -->
                <div class="wrapper">
                    <div class="search-input">
                        <a href="" target="_blank" hidden></a>
                        <input id="" type="text" placeholder="Search for your next read..." />
                    </div>
                </div>
            </div>
        </div>
        <div class="autocom-box">
        </div>
        <div id="answer-box"> </div>
    </div>
    <!-- This is for the SVD search page -->
    <div class="full-body-container-2" style="display: none;">
        <button onclick="showIntroduction()">Go back to main page</button>
        <div class="top-text">
            <div class="google-colors">
                <h1 id="google-1">B</h1>
                <h1 id="google-2">O</h1>
                <h1 id="google-3">O</h1>
                <h1 id="google-4">K</h1>
                <h1 id="google-5">H</h1>
                <h1 id="google-2">U</h1>
                <h1 id="google-3">B</h1>
            </div>
            <h3 class='book-version-title'>Version: Mood Input</h3>
            <p class='book-description'>Type in the mood or theme of the book you're looking for! We'll recommend a book that aligns with your mood!</p>
            <div class="input-box">
                <img src="{{ url_for('static', filename='images/mag.png' ) }}" />
                <!-- adapted from https://dev.to/codingnepal/search-bar-with-autocomplete-search-suggestions-in-javascript-32dn -->
                <input placeholder="Search by mood" id="mood-input"  maxlength="100"> 
            </div>
        </div>
        <div class="autocom-box-2">
        </div>
        <div id="answer-box-2"> </div>
    </div>
    <script src="../static/books_titles.js"></script>
    <script src="../static/moods.js"></script>

    <script>

        const resultBox = document.querySelector('.autocom-box-2');
        const input = document.getElementById('mood-input');
        input.onkeyup = (e) => {
            let userData = e.target.value; // user entered data
            let emptyArray = [];
            if (userData) {
                emptyArray = moods.filter((data) => {
                    return data.toLowerCase().startsWith(userData.toLowerCase());
                });
                emptyArray = emptyArray.map((data) => {
                    return `<ul>${data}</ul>`;
                });
                resultBox.classList.add('active'); // show autocomplete box
                showSuggestions2(emptyArray);
                let allList = resultBox.querySelectorAll('ul');
                console.log(allList)
                for (let i = 0; i < allList.length; i++) {
                    allList[i].setAttribute('onclick', 'select2(this)');
                }
            } else {
                resultBox.classList.remove('active'); // hide autocomplete box
            }
        };

        function showSuggestions2(list) {
            let listData;
            if (!list.length) {
                userValue = input.value;
                listData = `<ul>${userValue}</ul>`;
            } else {
                listData = list.join('');
            }
            resultBox.innerHTML = listData;
        };

        function select2(element) {
            let selectData = element.textContent;
            input.value = selectData;
            showMood()
            resultBox.classList.remove('active');
            input.focus();
        };


        function answerBox2(title, authors, description, score, count, image) {
            //to make sure if any of these is undefined, to replace it with the following
            title = (title !== undefined) ? title : "There's no title.";
            authors = (authors !== undefined) ? authors : "There are no authors.";
            description = (description !== undefined) ? description : "There's no description.";
            score = (score !== undefined) ? score : "There's no review score"; 
            count = (count !== undefined) ? count : "no"; 
            image = (image !== undefined) ? image : "/static/images/magic.jpeg"; 
            return `
                <div class='recommendation-container'>
                    <div class='book-details'>
                        <h3 class='book-title'>Title: ${title}</h3>
                        <p class='book-authors'>Authors: ${authors}</p>
                        <p class='book-description'>Description: ${description}</p>
                        <p class='book-review-score-count'>Rating: ${score} based on ${count} reviews. </p>
                    </div>
                    <img src="${image}" alt="Book cover" class='book-image' />
                </div>`;
        };

        function sendFocus2() {
            document.getElementById('mood-input').focus();
        };


        function showMood() {
            console.log("inside showmood")
            const answerBox = document.getElementById('answer-box-2');
            answerBox.innerHTML = '';
            interest = input.value;
            if (interest.trim() !== '') {
                fetch("/mood?" + new URLSearchParams({ mood: interest.value }))
                    .then(response => response.json())
                    .then(data => {
                        data.forEach(book => {
                            const bookDivClass = document.createElement('div');
                            console.log("the rec book is "+book);
                            bookDivClass.innerHTML = answerBox2(book.Title, book.authors, book.descript, book.review_score, book.review_count, book.image);
                            answerBox.appendChild(bookDivClass);
                        });
                    })
            }
        };

        // Help switch from intro page to the search page
        function showSearch(containerClass) {
            document.querySelector('.introduction-page').style.display = 'none';
            document.querySelector('.full-body-container').style.display = 'none';
            document.querySelector('.full-body-container-2').style.display = 'none';
            document.querySelector('.' + containerClass).style.display = 'block';
        };
        //lets user go back to the intro/main page
        function showIntroduction() {
            document.querySelector('.introduction-page').style.display = 'block';
            document.querySelector('.full-body-container').style.display = 'none';
            document.querySelector('.full-body-container-2').style.display = 'none';
        };
        const searchWrapper = document.querySelector('.search-input');
        const inputBox = searchWrapper.querySelector('input');
        const suggBox = document.querySelector('.autocom-box');
        const icon = document.getElementsByClassName('fa-search');


        let webLink;

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                searchWrapper.classList.remove('active');
                query();
                document.activeElement.blur();
                return;
            }
        });

        // search icon onclick
        icon.onclick = () => {
            searchWrapper.classList.remove('active');
            query();
            return;
        };

        // if user presses any key and releases
        inputBox.onkeyup = (e) => {
            let userData = e.target.value; 
            let emptyArray = [];
            if (userData) {
                emptyArray = titles.filter((data) => {
                    return data.toLowerCase().startsWith(userData.toLowerCase());
                });
                emptyArray = emptyArray.map((data) => {
                    return `<ul>${data}</ul>`;
                });
                suggBox.classList.add('active'); 
                showSuggestions(emptyArray);
                let allList = suggBox.querySelectorAll('ul');
                for (let i = 0; i < allList.length; i++) {
                    allList[i].setAttribute('onclick', 'select(this)');
                }
            } else {
                suggBox.classList.remove('active'); 
            }
        };

        function select(element) {
            let selectData = element.textContent;
            inputBox.value = selectData;
            query()
            searchWrapper.classList.remove('active');
            inputBox.focus();
        };

        function showSuggestions(list) {

            let listData;
            if (!list.length) {
                userValue = inputBox.value;
                listData = `<ul>${userValue}</ul>`;
            } else {
                listData = list.join('');
            }
            suggBox.innerHTML = listData;
        };

        inputBox.addEventListener('focusout', (e) =>
            setTimeout(() => searchWrapper.classList.remove('active'), 200)
        );

        function answerBoxTemplate(title, authors, categories, description, score, count, image) {
            return `
                <div class='recommendation-container'>
                    <div class='book-details'>
                        <h3 class='book-title'>Title: ${title}</h3>
                        <p class='book-authors'>Authors: ${authors}</p>
                        <p class='book-categories'>Categories: ${categories}</p>
                        <p class='book-description'>Description: ${description}</p>
                        <p class='book-review-score-count'>Review Score: ${score} (${count})</p>
                    </div>
                    <img src="${image}" alt="Book cover" class='book-image'/>
                </div>`;
        };


        function sendFocus() {
            document.getElementsByClassName('input-box').focus();
        };

        function query() {
            searchWrapper.classList.remove('active');

            let searchParams = new URLSearchParams();
            searchParams.append('title', inputBox.value);

            let searchText = inputBox.value.trim();
            suggBox.innerHTML = "";

            if (searchText !== "") {
                fetch("/books?" + new URLSearchParams({ title: searchText }).toString())
                    .then((response) => response.json())
                    .then((data) => {
                        let output_div = document.getElementById("answer-box")
                        document.getElementById("answer-box").innerHTML = "";
                        data.slice(0, 10).forEach(row => {
                            let tempDiv = document.createElement("div");
                            tempDiv.innerHTML = answerBoxTemplate(row.Title, row.authors, row.categories, row.descript, row.review_score, row.review_count, row.image);
                            document.getElementById("answer-box").appendChild(tempDiv);
                        });
                    });
            }
        };
    </script>

</body>

</html>